2026-01-16 13:08:06,391 - shipping_chatbot - INFO - User_Query: What is starlink, consignee_code: ['0000866']
2026-01-16 14:35:40,799 - shipping_chatbot - INFO - AzureChatOpenAI ready
2026-01-16 14:35:40,799 - shipping_chatbot - INFO - Agent created with 4 tools
2026-01-16 14:35:40,799 - shipping_chatbot - INFO - Agent ready for HTTP requests
2026-01-16 14:36:39,146 - shipping_chatbot - INFO - User_Query: What is starlink, consignee_code: ['0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569', '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052', '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360', '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453', '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359', '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392']
2026-01-16 14:36:39,147 - shipping_chatbot - INFO - Downloading shipment CSV from Azure Blob Storage
2026-01-16 14:36:53,570 - shipping_chatbot - INFO - Fetched 19279 rows
2026-01-16 14:36:53,572 - shipping_chatbot - INFO - Starting preprocessing on 19279 rows
2026-01-16 14:36:53,658 - shipping_chatbot - INFO - Removed 0 duplicate rows
2026-01-16 14:36:54,200 - shipping_chatbot - INFO - Converted 31 date columns to datetime format
2026-01-16 14:36:54,350 - shipping_chatbot - INFO - Normalized 6 'multiple' columns
2026-01-16 14:36:54,886 - shipping_chatbot - INFO - Added `delay_days` column with FIXED logic
2026-01-16 14:36:54,890 - shipping_chatbot - INFO - Added `actual_transit_days` column
2026-01-16 14:36:54,890 - shipping_chatbot - INFO - Added `estimated_transit_days` column
2026-01-16 14:36:54,917 - shipping_chatbot - INFO - Pre-processing finished - 19279 rows remain
2026-01-16 14:37:02,503 - shipping_chatbot - INFO - AGENT_STEP: 1 | Tool Used: Handle Non-shipping queries | Tool Input: {'query': 'What is Starlink?'}
2026-01-16 14:43:13,385 - shipping_chatbot - INFO - User_Query: and mcs, consignee_code: ['0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569', '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052', '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360', '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453', '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359', '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392']
2026-01-16 14:43:21,725 - shipping_chatbot - INFO - AGENT_STEP: 1 | Tool Used: Handle Non-shipping queries | Tool Input: {'query': 'What is MCS?'}
2026-01-16 14:43:58,998 - shipping_chatbot - INFO - User_Query: Can you quickly share its website, please, consignee_code: ['0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569', '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052', '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360', '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453', '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359', '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392']
2026-01-16 14:44:05,268 - shipping_chatbot - INFO - AGENT_STEP: 1 | Tool Used: Handle Non-shipping queries | Tool Input: {'query': 'What is the website of MOL Consolidation Service (MCS)?'}
2026-01-16 14:44:54,340 - shipping_chatbot - INFO - User_Query: what is there business offerings, consignee_code: ['0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569', '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052', '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360', '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453', '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359', '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392']
2026-01-16 14:45:07,030 - shipping_chatbot - INFO - AGENT_STEP: 1 | Tool Used: Handle Non-shipping queries | Tool Input: {'query': 'What are the business offerings of MOL Consolidation Service (MCS)?'}
2026-01-16 14:49:24,646 - shipping_chatbot - INFO - User_Query: What is status of 5302997239?, consignee_code: ['0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569', '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052', '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360', '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453', '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359', '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392']
2026-01-16 14:49:26,994 - shipping_chatbot - INFO - [get_container_milestones] Searching for PO: 5302997239
2026-01-16 14:49:27,041 - shipping_chatbot - INFO - [get_container_milestones] PO match results: 1 rows found
2026-01-16 14:49:27,050 - shipping_chatbot - INFO - AGENT_STEP: 1 | Tool Used: Get Container Milestones | Tool Input: PO 5302997239
2026-01-16 14:50:03,878 - shipping_chatbot - INFO - User_Query: What is status of the PO 5302850125?, consignee_code: ['0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569', '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052', '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360', '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453', '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359', '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392']
2026-01-16 14:50:06,195 - shipping_chatbot - INFO - [get_container_milestones] Searching for PO: 5302850125
2026-01-16 14:50:06,240 - shipping_chatbot - INFO - [get_container_milestones] PO match results: 4 rows found
2026-01-16 14:50:06,246 - shipping_chatbot - INFO - AGENT_STEP: 1 | Tool Used: Get Container Milestones | Tool Input: PO 5302850125
2026-01-16 14:50:32,278 - shipping_chatbot - INFO - User_Query: What are the POs in the container TCLU4703170?, consignee_code: ['0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569', '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052', '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360', '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453', '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359', '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392']
2026-01-16 14:50:34,655 - shipping_chatbot - INFO - AGENT_STEP: 1 | Tool Used: Get Container Milestones | Tool Input: container TCLU4703170
2026-01-16 14:51:24,831 - shipping_chatbot - INFO - User_Query: What is the container carrying the PO 5302997239?, consignee_code: ['0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569', '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052', '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360', '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453', '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359', '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392']
2026-01-16 14:51:27,166 - shipping_chatbot - INFO - [get_container_milestones] Searching for PO: 5302997239
2026-01-16 14:51:27,217 - shipping_chatbot - INFO - [get_container_milestones] PO match results: 1 rows found
2026-01-16 14:51:27,224 - shipping_chatbot - INFO - AGENT_STEP: 1 | Tool Used: Get Container Milestones | Tool Input: PO 5302997239
2026-01-16 14:52:15,978 - shipping_chatbot - INFO - User_Query: What are the POs arriving in Los Angeles?, consignee_code: ['0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569', '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052', '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360', '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453', '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359', '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392']
2026-01-16 14:52:19,575 - shipping_chatbot - INFO - Analyst Engine processing query: filter rows where hot_container_flag is TRUE and (discharge_port or vehicle_arrival_lcn) contains (USLAX) and ata_dp is not null; select distinct po_number_multiple
2026-01-16 14:52:23,847 - shipping_chatbot - INFO - ========================================
2026-01-16 14:52:23,847 - shipping_chatbot - INFO - ANALYST ENGINE DEBUG MODE
2026-01-16 14:52:23,847 - shipping_chatbot - INFO - QUERY: filter rows where hot_container_flag is TRUE and (discharge_port or vehicle_arrival_lcn) contains (USLAX) and ata_dp is not null; select distinct po_number_multiple
2026-01-16 14:52:23,847 - shipping_chatbot - INFO - GENERATED CODE:
# Normalize hot_container_flag to boolean True
hot_flags = ['TRUE', 'Y', 'YES', 1, True]
mask_hot = df['hot_container_flag'].fillna('').astype(str).str.upper().isin([str(x).upper() for x in hot_flags])

# Filter rows where discharge_port or vehicle_arrival_lcn contains 'USLAX'
mask_port = df['discharge_port'].fillna('').str.contains('USLAX', na=False) | df['vehicle_arrival_lcn'].fillna('').str.contains('USLAX', na=False)

# Filter rows where ata_dp is not null
mask_ata = df['ata_dp'].notna()

# Apply all filters
filtered_df = df[mask_hot & mask_port & mask_ata]

# Select distinct po_number_multiple values
distinct_pos = filtered_df['po_number_multiple'].dropna().unique()

# Format result as a comma-separated string of POs
result = ', '.join(sorted(distinct_pos))
2026-01-16 14:52:23,847 - shipping_chatbot - INFO - ========================================
2026-01-16 14:52:23,865 - shipping_chatbot - INFO - ANALYST ENGINE SUCCESS: Result obtained (length: 17463)
2026-01-16 14:54:38,383 - shipping_chatbot - INFO - AGENT_STEP: 1 | Tool Used: Analyze Data with Pandas | Tool Input: filter rows where hot_container_flag is TRUE and (discharge_port or vehicle_arrival_lcn) contains (USLAX) and ata_dp is not null; select distinct po_number_multiple
2026-01-16 14:56:21,135 - shipping_chatbot - INFO - User_Query: give for wilson sporting goods co only, consignee_code: ['0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569', '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052', '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360', '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453', '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359', '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392']
2026-01-16 14:56:24,711 - shipping_chatbot - INFO - Analyst Engine processing query: Filter data where hot_container_flag is TRUE and consignee_code_multiple contains '0009633' (Wilson Sporting Goods Co). Return distinct po_number_multiple values for containers arriving at Los Angeles (USLAX) with ata_dp NOT NULL.
2026-01-16 14:56:30,703 - shipping_chatbot - INFO - ========================================
2026-01-16 14:56:30,703 - shipping_chatbot - INFO - ANALYST ENGINE DEBUG MODE
2026-01-16 14:56:30,704 - shipping_chatbot - INFO - QUERY: Filter data where hot_container_flag is TRUE and consignee_code_multiple contains '0009633' (Wilson Sporting Goods Co). Return distinct po_number_multiple values for containers arriving at Los Angeles (USLAX) with ata_dp NOT NULL.
2026-01-16 14:56:30,704 - shipping_chatbot - INFO - GENERATED CODE:
# Normalize hot_container_flag to boolean True
hot_flags = ['TRUE', 'Y', 'YES', 1, True]
mask_hot = df['hot_container_flag'].astype(str).str.upper().isin([str(f).upper() for f in hot_flags])

# Filter for consignee_code_multiple containing '0009633'
mask_consignee = df['consignee_code_multiple'].str.contains('0009633', na=False)

# Filter for discharge_port containing 'USLAX'
mask_port = df['discharge_port'].str.contains('USLAX', na=False)

# Filter for ata_dp not null
mask_ata = df['ata_dp'].notna()

# Apply all filters
filtered_df = df[mask_hot & mask_consignee & mask_port & mask_ata]

# Extract distinct po_number_multiple values, split by comma, strip spaces, and get unique
po_series = filtered_df['po_number_multiple'].dropna().str.split(',')

# Flatten list of lists and strip spaces
po_list = [po.strip() for sublist in po_series for po in sublist]

# Get unique POs
unique_pos = sorted(set(po_list))

result = ', '.join(unique_pos)
2026-01-16 14:56:30,704 - shipping_chatbot - INFO - ========================================
2026-01-16 14:56:30,714 - shipping_chatbot - INFO - ANALYST ENGINE SUCCESS: Result obtained (length: 0)
2026-01-16 14:56:35,700 - shipping_chatbot - INFO - AGENT_STEP: 1 | Tool Used: Analyze Data with Pandas | Tool Input: Filter data where hot_container_flag is TRUE and consignee_code_multiple contains '0009633' (Wilson Sporting Goods Co). Return distinct po_number_multiple values for containers arriving at Los Angeles (USLAX) with ata_dp NOT NULL.
2026-01-16 14:57:02,629 - shipping_chatbot - INFO - User_Query: give fro 00008666, consignee_code: ['0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569', '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052', '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360', '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453', '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359', '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392']
2026-01-16 14:58:05,515 - shipping_chatbot - INFO - User_Query: What are the POs arriving in Los Angeles?, consignee_code: ['0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569', '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052', '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360', '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453', '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359', '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392']
2026-01-16 14:58:13,521 - shipping_chatbot - INFO - Analyst Engine processing query: List distinct po_number_multiple where hot_container_flag is TRUE and ata_dp is not null and (discharge_port like '%(USLAX)%' or vehicle_arrival_lcn like '%(USLAX)%') and consignee_code_multiple in ('0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569', '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052', '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360', '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453', '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359', '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392')
2026-01-16 14:58:22,308 - shipping_chatbot - INFO - ========================================
2026-01-16 14:58:22,309 - shipping_chatbot - INFO - ANALYST ENGINE DEBUG MODE
2026-01-16 14:58:22,309 - shipping_chatbot - INFO - QUERY: List distinct po_number_multiple where hot_container_flag is TRUE and ata_dp is not null and (discharge_port like '%(USLAX)%' or vehicle_arrival_lcn like '%(USLAX)%') and consignee_code_multiple in ('0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569', '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052', '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360', '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453', '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359', '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392')
2026-01-16 14:58:22,309 - shipping_chatbot - INFO - GENERATED CODE:
# Normalize hot_container_flag to boolean True
hot_flags = ['TRUE', 'Y', 'YES', 1, True]

# Filter conditions
mask_hot = df['hot_container_flag'].isin(hot_flags)
mask_ata = df['ata_dp'].notna()
mask_port = df['discharge_port'].str.contains(r'\(USLAX\)', na=False) | df['vehicle_arrival_lcn'].str.contains(r'\(USLAX\)', na=False)
authorized_consignees = ['0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569', '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052', '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360', '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453', '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359', '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392']
mask_consignee = df['consignee_code_multiple'].apply(lambda x: any(code in x.split(',') for code in authorized_consignees) if pd.notna(x) else False)

filtered_df = df[mask_hot & mask_ata & mask_port & mask_consignee]

# Extract distinct PO numbers from po_number_multiple (comma-separated)
# Split and explode to get distinct POs
po_series = filtered_df['po_number_multiple'].dropna().str.split(',').explode().str.strip().drop_duplicates()

result = ', '.join(po_series.tolist())
2026-01-16 14:58:22,309 - shipping_chatbot - INFO - ========================================
2026-01-16 14:58:22,318 - shipping_chatbot - ERROR - Analyst Engine failed: name 'pd' is not defined
Traceback (most recent call last):
  File "C:\Users\CHOWDHURYRaju\Desktop\roshan\StlnkWebNprdChatV2\agents\analytics_engine.py", line 113, in analyze
    exec(code, {}, local_vars)
  File "<string>", line 9, in <module>
  File "C:\Python311\Lib\site-packages\pandas\core\series.py", line 4935, in apply
    ).apply()
      ^^^^^^^
  File "C:\Python311\Lib\site-packages\pandas\core\apply.py", line 1422, in apply
    return self.apply_standard()
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Python311\Lib\site-packages\pandas\core\apply.py", line 1502, in apply_standard
    mapped = obj._map_values(
             ^^^^^^^^^^^^^^^^
  File "C:\Python311\Lib\site-packages\pandas\core\base.py", line 925, in _map_values
    return algorithms.map_array(arr, mapper, na_action=na_action, convert=convert)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Python311\Lib\site-packages\pandas\core\algorithms.py", line 1743, in map_array
    return lib.map_infer(values, mapper, convert=convert)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "pandas/_libs/lib.pyx", line 2999, in pandas._libs.lib.map_infer
  File "<string>", line 9, in <lambda>
NameError: name 'pd' is not defined
2026-01-16 14:58:22,475 - shipping_chatbot - ERROR - FAILED CODE:
# Normalize hot_container_flag to boolean True
hot_flags = ['TRUE', 'Y', 'YES', 1, True]

# Filter conditions
mask_hot = df['hot_container_flag'].isin(hot_flags)
mask_ata = df['ata_dp'].notna()
mask_port = df['discharge_port'].str.contains(r'\(USLAX\)', na=False) | df['vehicle_arrival_lcn'].str.contains(r'\(USLAX\)', na=False)
authorized_consignees = ['0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569', '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052', '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360', '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453', '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359', '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392']
mask_consignee = df['consignee_code_multiple'].apply(lambda x: any(code in x.split(',') for code in authorized_consignees) if pd.notna(x) else False)

filtered_df = df[mask_hot & mask_ata & mask_port & mask_consignee]

# Extract distinct PO numbers from po_number_multiple (comma-separated)
# Split and explode to get distinct POs
po_series = filtered_df['po_number_multiple'].dropna().str.split(',').explode().str.strip().drop_duplicates()

result = ', '.join(po_series.tolist())
2026-01-16 14:58:35,100 - shipping_chatbot - INFO - Analyst Engine processing query: List distinct po_number_multiple where hot_container_flag in ('Y', 'YES', 'TRUE', '1', 'HOT') and ata_dp is not null and (discharge_port like '%(USLAX)%' or vehicle_arrival_lcn like '%(USLAX)%') and consignee_code_multiple in ('0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569', '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052', '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360', '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453', '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359', '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392')
2026-01-16 14:58:45,681 - shipping_chatbot - INFO - ========================================
2026-01-16 14:58:45,682 - shipping_chatbot - INFO - ANALYST ENGINE DEBUG MODE
2026-01-16 14:58:45,682 - shipping_chatbot - INFO - QUERY: List distinct po_number_multiple where hot_container_flag in ('Y', 'YES', 'TRUE', '1', 'HOT') and ata_dp is not null and (discharge_port like '%(USLAX)%' or vehicle_arrival_lcn like '%(USLAX)%') and consignee_code_multiple in ('0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569', '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052', '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360', '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453', '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359', '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392')
2026-01-16 14:58:45,683 - shipping_chatbot - INFO - GENERATED CODE:
# Normalize hot_container_flag values to uppercase string for consistent filtering
hot_flags = {'Y', 'YES', 'TRUE', '1', 'HOT'}

# Filter for authorized consignee codes
authorized_consignees = {
    '0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569',
    '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052',
    '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360',
    '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453',
    '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359',
    '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392'
}

# Create a mask for hot_container_flag
hot_mask = df['hot_container_flag'].astype(str).str.upper().isin(hot_flags)

# Create a mask for ata_dp not null
ata_mask = df['ata_dp'].notna()

# Create a mask for discharge_port or vehicle_arrival_lcn containing '(USLAX)'
port_mask = (
    df['discharge_port'].str.contains(r'\(USLAX\)', na=False) |
    df['vehicle_arrival_lcn'].str.contains(r'\(USLAX\)', na=False)
)

# Create a mask for authorized consignee codes in consignee_code_multiple (comma-separated)
# We check if any authorized code is contained in the string
consignee_mask = df['consignee_code_multiple'].apply(
    lambda x: any(code in str(x).split(',') for code in authorized_consignees)
)

# Combine all masks
final_mask = hot_mask & ata_mask & port_mask & consignee_mask

# Filter dataframe
filtered_df = df.loc[final_mask, 'po_number_multiple'].dropna().unique()

# Convert numpy array to sorted list and join by comma
po_list = sorted(filtered_df)
result = ', '.join(po_list)
2026-01-16 14:58:45,684 - shipping_chatbot - INFO - ========================================
2026-01-16 14:58:45,693 - shipping_chatbot - ERROR - Analyst Engine failed: name 'authorized_consignees' is not defined
Traceback (most recent call last):
  File "C:\Users\CHOWDHURYRaju\Desktop\roshan\StlnkWebNprdChatV2\agents\analytics_engine.py", line 113, in analyze
    exec(code, {}, local_vars)
  File "<string>", line 28, in <module>
  File "C:\Python311\Lib\site-packages\pandas\core\series.py", line 4935, in apply
    ).apply()
      ^^^^^^^
  File "C:\Python311\Lib\site-packages\pandas\core\apply.py", line 1422, in apply
    return self.apply_standard()
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Python311\Lib\site-packages\pandas\core\apply.py", line 1502, in apply_standard
    mapped = obj._map_values(
             ^^^^^^^^^^^^^^^^
  File "C:\Python311\Lib\site-packages\pandas\core\base.py", line 925, in _map_values
    return algorithms.map_array(arr, mapper, na_action=na_action, convert=convert)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Python311\Lib\site-packages\pandas\core\algorithms.py", line 1743, in map_array
    return lib.map_infer(values, mapper, convert=convert)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "pandas/_libs/lib.pyx", line 2999, in pandas._libs.lib.map_infer
  File "<string>", line 29, in <lambda>
NameError: name 'authorized_consignees' is not defined
2026-01-16 14:58:45,693 - shipping_chatbot - ERROR - FAILED CODE:
# Normalize hot_container_flag values to uppercase string for consistent filtering
hot_flags = {'Y', 'YES', 'TRUE', '1', 'HOT'}

# Filter for authorized consignee codes
authorized_consignees = {
    '0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569',
    '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052',
    '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360',
    '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453',
    '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359',
    '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392'
}

# Create a mask for hot_container_flag
hot_mask = df['hot_container_flag'].astype(str).str.upper().isin(hot_flags)

# Create a mask for ata_dp not null
ata_mask = df['ata_dp'].notna()

# Create a mask for discharge_port or vehicle_arrival_lcn containing '(USLAX)'
port_mask = (
    df['discharge_port'].str.contains(r'\(USLAX\)', na=False) |
    df['vehicle_arrival_lcn'].str.contains(r'\(USLAX\)', na=False)
)

# Create a mask for authorized consignee codes in consignee_code_multiple (comma-separated)
# We check if any authorized code is contained in the string
consignee_mask = df['consignee_code_multiple'].apply(
    lambda x: any(code in str(x).split(',') for code in authorized_consignees)
)

# Combine all masks
final_mask = hot_mask & ata_mask & port_mask & consignee_mask

# Filter dataframe
filtered_df = df.loc[final_mask, 'po_number_multiple'].dropna().unique()

# Convert numpy array to sorted list and join by comma
po_list = sorted(filtered_df)
result = ', '.join(po_list)
2026-01-16 14:58:52,843 - shipping_chatbot - INFO - Analyst Engine processing query: List distinct po_number_multiple where hot_container_flag in ('Y', 'YES', 'TRUE', '1', 'HOT') and ata_dp is not null and (discharge_port like '%(USLAX)%' or vehicle_arrival_lcn like '%(USLAX)%') and consignee_code_multiple in ('0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569', '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052', '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360', '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453', '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359', '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392')
2026-01-16 14:59:02,057 - shipping_chatbot - INFO - ========================================
2026-01-16 14:59:02,059 - shipping_chatbot - INFO - ANALYST ENGINE DEBUG MODE
2026-01-16 14:59:02,060 - shipping_chatbot - INFO - QUERY: List distinct po_number_multiple where hot_container_flag in ('Y', 'YES', 'TRUE', '1', 'HOT') and ata_dp is not null and (discharge_port like '%(USLAX)%' or vehicle_arrival_lcn like '%(USLAX)%') and consignee_code_multiple in ('0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569', '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052', '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360', '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453', '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359', '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392')
2026-01-16 14:59:02,060 - shipping_chatbot - INFO - GENERATED CODE:
# Normalize hot_container_flag to uppercase string for consistent filtering
hot_flags = {'Y', 'YES', 'TRUE', '1', 'HOT'}

# Filter for authorized consignee codes
authorized_consignees = {
    '0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569',
    '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052',
    '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360',
    '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453',
    '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359',
    '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392'
}

# Create a mask for hot_container_flag
hot_mask = df['hot_container_flag'].astype(str).str.upper().isin(hot_flags)

# Create a mask for ata_dp not null
ata_mask = df['ata_dp'].notna()

# Create a mask for discharge_port or vehicle_arrival_lcn containing (USLAX)
port_mask = (
    df['discharge_port'].str.contains(r'\(USLAX\)', na=False) |
    df['vehicle_arrival_lcn'].str.contains(r'\(USLAX\)', na=False)
)

# Create a mask for authorized consignee codes in consignee_code_multiple
# Since consignee_code_multiple is multiple codes comma separated, use str.contains for each authorized code
# But to optimize, create a regex pattern joining all authorized codes separated by '|'
import re
pattern = '|'.join(authorized_consignees)
consignee_mask = df['consignee_code_multiple'].str.contains(pattern, na=False)

# Combine all masks
final_mask = hot_mask & ata_mask & port_mask & consignee_mask

# Filter dataframe
filtered_df = df.loc[final_mask, 'po_number_multiple']

# Extract distinct PO numbers from the comma-separated strings
# Split by comma, strip spaces, flatten and get unique
po_series = filtered_df.dropna().str.split(',').explode().str.strip().drop_duplicates()

# Convert to list and join by comma for readable output
result = ', '.join(po_series.tolist())
2026-01-16 14:59:02,062 - shipping_chatbot - INFO - ========================================
2026-01-16 14:59:02,119 - shipping_chatbot - INFO - ANALYST ENGINE SUCCESS: Result obtained (length: 17062)
2026-01-16 15:01:03,862 - shipping_chatbot - INFO - AGENT_STEP: 1 | Tool Used: Analyze Data with Pandas | Tool Input: List distinct po_number_multiple where hot_container_flag is TRUE and ata_dp is not null and (discharge_port like '%(USLAX)%' or vehicle_arrival_lcn like '%(USLAX)%') and consignee_code_multiple in ('0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569', '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052', '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360', '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453', '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359', '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392')
2026-01-16 15:01:03,862 - shipping_chatbot - INFO - AGENT_STEP: 2 | Tool Used: _Exception | Tool Input: Invalid or incomplete response
2026-01-16 15:01:03,862 - shipping_chatbot - INFO - AGENT_STEP: 3 | Tool Used: Analyze Data with Pandas | Tool Input: List distinct po_number_multiple where hot_container_flag in ('Y', 'YES', 'TRUE', '1', 'HOT') and ata_dp is not null and (discharge_port like '%(USLAX)%' or vehicle_arrival_lcn like '%(USLAX)%') and consignee_code_multiple in ('0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569', '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052', '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360', '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453', '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359', '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392')
2026-01-16 15:01:03,862 - shipping_chatbot - INFO - AGENT_STEP: 4 | Tool Used: Analyze Data with Pandas | Tool Input: List distinct po_number_multiple where hot_container_flag in ('Y', 'YES', 'TRUE', '1', 'HOT') and ata_dp is not null and (discharge_port like '%(USLAX)%' or vehicle_arrival_lcn like '%(USLAX)%') and consignee_code_multiple in ('0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569', '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052', '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360', '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453', '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359', '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392')
2026-01-16 15:10:48,628 - shipping_chatbot - INFO - User_Query: Please provide the shipment status of 5302970007, consignee_code: ['0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569', '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052', '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360', '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453', '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359', '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392']
2026-01-16 15:10:51,504 - shipping_chatbot - INFO - [get_container_milestones] Searching for PO: 5302970007
2026-01-16 15:10:51,548 - shipping_chatbot - INFO - [get_container_milestones] PO match results: 1 rows found
2026-01-16 15:10:51,554 - shipping_chatbot - INFO - AGENT_STEP: 1 | Tool Used: Get Container Milestones | Tool Input: PO 5302970007
2026-01-16 15:11:10,119 - shipping_chatbot - INFO - User_Query: List out any delay shipments in Augest, consignee_code: ['0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569', '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052', '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360', '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453', '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359', '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392']
2026-01-16 15:11:13,611 - shipping_chatbot - INFO - Analyst Engine processing query: Find shipments with hot_container_flag TRUE, ata_dp NOT NULL, delay_days > 0, and ata_dp in August 2025.
2026-01-16 15:11:21,284 - shipping_chatbot - INFO - ========================================
2026-01-16 15:11:21,284 - shipping_chatbot - INFO - ANALYST ENGINE DEBUG MODE
2026-01-16 15:11:21,285 - shipping_chatbot - INFO - QUERY: Find shipments with hot_container_flag TRUE, ata_dp NOT NULL, delay_days > 0, and ata_dp in August 2025.
2026-01-16 15:11:21,285 - shipping_chatbot - INFO - GENERATED CODE:
# Filter for hot containers
hot_flags = ['TRUE', 'Y', 'YES', 1, True]
df['hot_flag_bool'] = df['hot_container_flag'].astype(str).str.upper().isin(['TRUE', 'Y', 'YES']) | (df['hot_container_flag'] == 1) | (df['hot_container_flag'] == True)

# Convert ata_dp to datetime if not already
df['ata_dp'] = pd.to_datetime(df['ata_dp'], errors='coerce')

# Define August 2025 date range
start_date = pd.Timestamp('2025-08-01')
end_date = pd.Timestamp('2025-08-31')

# Filter conditions
cond = (
    df['hot_flag_bool'] &
    df['ata_dp'].notna() &
    (df['delay_days'] > 0) &
    (df['ata_dp'] >= start_date) &
    (df['ata_dp'] <= end_date)
)

# Select relevant columns for output
filtered = df.loc[cond, ['container_number', 'po_number_multiple', 'ata_dp', 'delay_days']]

# Format result as readable string list
if filtered.empty:
    result = "No shipments found with hot_container_flag TRUE, ata_dp in August 2025, and delay_days > 0."
else:
    lines = []
    for _, row in filtered.iterrows():
        lines.append(f"Container: {row['container_number']}, POs: {row['po_number_multiple']}, Arrival: {row['ata_dp'].date()}, Delay Days: {row['delay_days']}")
    result = "\n".join(lines)
2026-01-16 15:11:21,285 - shipping_chatbot - INFO - ========================================
2026-01-16 15:11:21,304 - shipping_chatbot - INFO - ANALYST ENGINE SUCCESS: Result obtained (length: 3757)
2026-01-16 15:11:49,836 - shipping_chatbot - ERROR - Agent failed: 2 validation errors for AIMessage
content
  str type expected (type=type_error.str)
content
  value is not a valid list (type=type_error.list)
Traceback (most recent call last):
  File "C:\Users\CHOWDHURYRaju\Desktop\roshan\StlnkWebNprdChatV2\api\main.py", line 212, in ask
    SESSION_HISTORY[session_id].add_ai_message(result.get("output", ""))
  File "C:\Users\CHOWDHURYRaju\AppData\Roaming\Python\Python311\site-packages\langchain_core\chat_history.py", line 139, in add_ai_message
    self.add_message(AIMessage(content=message))
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\CHOWDHURYRaju\AppData\Roaming\Python\Python311\site-packages\langchain_core\messages\base.py", line 47, in __init__
    return super().__init__(content=content, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\CHOWDHURYRaju\AppData\Roaming\Python\Python311\site-packages\pydantic\v1\main.py", line 347, in __init__
    raise validation_error
pydantic.v1.error_wrappers.ValidationError: 2 validation errors for AIMessage
content
  str type expected (type=type_error.str)
content
  value is not a valid list (type=type_error.list)
2026-01-16 15:11:49,896 - shipping_chatbot - INFO - Router: Set context (codes: ['0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569', '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052', '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360', '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453', '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359', '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392'], has_history: True) for query: List out any delay shipments in Augest
2026-01-16 15:11:49,960 - shipping_chatbot - INFO - Consignee filtering validated: 12915 rows for codes ['0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569', '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052', '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360', '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453', '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359', '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392']
2026-01-20 12:20:19,375 - shipping_chatbot - INFO - AzureChatOpenAI ready
2026-01-20 12:20:19,378 - shipping_chatbot - INFO - Agent created with 4 tools
2026-01-20 12:20:19,378 - shipping_chatbot - INFO - Agent ready for HTTP requests
2026-01-20 12:22:12,331 - shipping_chatbot - INFO - User_Query: let me know vendor name for 5302842571, consignee_code: ['0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569', '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052', '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360', '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453', '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359', '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392']
2026-01-20 12:22:12,331 - shipping_chatbot - INFO - Downloading shipment CSV from Azure Blob Storage
2026-01-20 12:22:25,787 - shipping_chatbot - INFO - Fetched 18991 rows
2026-01-20 12:22:25,792 - shipping_chatbot - INFO - Starting preprocessing on 18991 rows
2026-01-20 12:22:26,005 - shipping_chatbot - INFO - Removed 0 duplicate rows
2026-01-20 12:22:27,238 - shipping_chatbot - INFO - Converted 31 date columns to datetime format
2026-01-20 12:22:27,631 - shipping_chatbot - INFO - Normalized 6 'multiple' columns
2026-01-20 12:22:28,529 - shipping_chatbot - INFO - Added `delay_days` column with FIXED logic
2026-01-20 12:22:28,531 - shipping_chatbot - INFO - Added `actual_transit_days` column
2026-01-20 12:22:28,536 - shipping_chatbot - INFO - Added `estimated_transit_days` column
2026-01-20 12:22:28,657 - shipping_chatbot - INFO - Pre-processing finished - 18991 rows remain
2026-01-20 12:22:32,661 - shipping_chatbot - INFO - Analyst Engine processing query: select supplier_vendor_name from dataset where po_number_multiple like '%5302842571%' and hot_container_flag in ('Y', 'YES', 'TRUE', '1', 'HOT')
2026-01-20 12:22:35,660 - shipping_chatbot - INFO - ========================================
2026-01-20 12:22:35,661 - shipping_chatbot - INFO - ANALYST ENGINE DEBUG MODE
2026-01-20 12:22:35,661 - shipping_chatbot - INFO - QUERY: select supplier_vendor_name from dataset where po_number_multiple like '%5302842571%' and hot_container_flag in ('Y', 'YES', 'TRUE', '1', 'HOT')
2026-01-20 12:22:35,661 - shipping_chatbot - INFO - GENERATED CODE:
authorized_consignees = df['consignee_code_multiple'].dropna().unique().tolist()
hot_flags = ['Y', 'YES', 'TRUE', '1', 'HOT']

filtered_df = df[
    df['po_number_multiple'].str.contains('5302842571', na=False) &
    df['hot_container_flag'].astype(str).str.upper().isin(hot_flags) &
    df['consignee_code_multiple'].apply(lambda x: any(consignee in x for consignee in authorized_consignees) if pd.notna(x) else False)
]

result = filtered_df['supplier_vendor_name'].dropna().unique().tolist()
result = str(result)
2026-01-20 12:22:35,661 - shipping_chatbot - INFO - ========================================
2026-01-20 12:22:35,672 - shipping_chatbot - ERROR - Analyst Engine failed: name 'pd' is not defined
Traceback (most recent call last):
  File "C:\Users\CHOWDHURYRaju\Desktop\roshan\StlnkWebNprdChatV2\agents\analytics_engine.py", line 118, in analyze
    exec(code, {}, local_vars)
  File "<string>", line 7, in <module>
  File "C:\Python311\Lib\site-packages\pandas\core\series.py", line 4935, in apply
    ).apply()
      ^^^^^^^
  File "C:\Python311\Lib\site-packages\pandas\core\apply.py", line 1422, in apply
    return self.apply_standard()
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Python311\Lib\site-packages\pandas\core\apply.py", line 1502, in apply_standard
    mapped = obj._map_values(
             ^^^^^^^^^^^^^^^^
  File "C:\Python311\Lib\site-packages\pandas\core\base.py", line 925, in _map_values
    return algorithms.map_array(arr, mapper, na_action=na_action, convert=convert)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Python311\Lib\site-packages\pandas\core\algorithms.py", line 1743, in map_array
    return lib.map_infer(values, mapper, convert=convert)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "pandas/_libs/lib.pyx", line 2999, in pandas._libs.lib.map_infer
  File "<string>", line 7, in <lambda>
NameError: name 'pd' is not defined
2026-01-20 12:22:35,734 - shipping_chatbot - ERROR - FAILED CODE:
authorized_consignees = df['consignee_code_multiple'].dropna().unique().tolist()
hot_flags = ['Y', 'YES', 'TRUE', '1', 'HOT']

filtered_df = df[
    df['po_number_multiple'].str.contains('5302842571', na=False) &
    df['hot_container_flag'].astype(str).str.upper().isin(hot_flags) &
    df['consignee_code_multiple'].apply(lambda x: any(consignee in x for consignee in authorized_consignees) if pd.notna(x) else False)
]

result = filtered_df['supplier_vendor_name'].dropna().unique().tolist()
result = str(result)
2026-01-20 12:22:36,767 - shipping_chatbot - INFO - [get_container_milestones] Searching for PO: 5302842571
2026-01-20 12:22:36,812 - shipping_chatbot - INFO - [get_container_milestones] PO match results: 1 rows found
2026-01-20 12:22:36,824 - shipping_chatbot - INFO - AGENT_STEP: 1 | Tool Used: Analyze Data with Pandas | Tool Input: select supplier_vendor_name from dataset where po_number_multiple like '%5302842571%' and hot_container_flag in ('Y', 'YES', 'TRUE', '1', 'HOT')
2026-01-20 12:22:36,824 - shipping_chatbot - INFO - AGENT_STEP: 2 | Tool Used: Get Container Milestones | Tool Input: 5302842571
2026-01-20 13:02:50,546 - shipping_chatbot - INFO - AzureChatOpenAI ready
2026-01-20 13:02:50,546 - shipping_chatbot - INFO - Agent created with 4 tools
2026-01-20 13:02:50,546 - shipping_chatbot - INFO - Agent ready for HTTP requests
2026-01-20 14:14:24,677 - shipping_chatbot - INFO - AzureChatOpenAI ready
2026-01-20 14:14:24,679 - shipping_chatbot - INFO - Agent created with 4 tools
2026-01-20 14:14:24,679 - shipping_chatbot - INFO - Agent ready for HTTP requests
2026-01-20 14:23:04,905 - shipping_chatbot - INFO - User_Query: cargo ready date for PO#6300146311, consignee_code: ['0028664', '0000866', '0005053', '0042485', '0042652', '0043881', '0043882', '0045831', '0048201', '0002907', '0048627', '0028664.']
2026-01-20 14:23:04,905 - shipping_chatbot - INFO - Downloading shipment CSV from Azure Blob Storage
2026-01-20 14:23:18,264 - shipping_chatbot - INFO - Fetched 18991 rows
2026-01-20 14:23:18,267 - shipping_chatbot - INFO - Starting preprocessing on 18991 rows
2026-01-20 14:23:18,341 - shipping_chatbot - INFO - Removed 0 duplicate rows
2026-01-20 14:23:18,864 - shipping_chatbot - INFO - Converted 31 date columns to datetime format
2026-01-20 14:23:19,010 - shipping_chatbot - INFO - Normalized 6 'multiple' columns
2026-01-20 14:23:19,465 - shipping_chatbot - INFO - Added `delay_days` column with FIXED logic
2026-01-20 14:23:19,466 - shipping_chatbot - INFO - Added `actual_transit_days` column
2026-01-20 14:23:19,467 - shipping_chatbot - INFO - Added `estimated_transit_days` column
2026-01-20 14:23:19,494 - shipping_chatbot - INFO - Pre-processing finished - 18991 rows remain
2026-01-20 14:23:21,696 - shipping_chatbot - INFO - [get_container_milestones] Searching for PO: 6300146311
2026-01-20 14:23:21,719 - shipping_chatbot - INFO - [get_container_milestones] PO match results: 1 rows found
2026-01-20 14:23:21,732 - shipping_chatbot - INFO - AGENT_STEP: 1 | Tool Used: Get Container Milestones | Tool Input: PO 6300146311
2026-01-20 14:24:21,728 - shipping_chatbot - INFO - User_Query: cargo ready date for PO#6300146311, consignee_code: ['0028664', '0000866', '0005053', '0042485', '0042652', '0043881', '0043882', '0045831', '0048201', '0002907', '0048627', '0028664.']
2026-01-20 14:24:24,261 - shipping_chatbot - INFO - [get_container_milestones] Searching for PO: 6300146311
2026-01-20 14:24:24,288 - shipping_chatbot - INFO - [get_container_milestones] PO match results: 1 rows found
2026-01-20 14:24:24,293 - shipping_chatbot - INFO - AGENT_STEP: 1 | Tool Used: Get Container Milestones | Tool Input: PO 6300146311
2026-01-20 14:25:34,807 - shipping_chatbot - INFO - User_Query: please check the vendor name of 6300146311, consignee_code: ['0028664', '0000866', '0005053', '0042485', '0042652', '0043881', '0043882', '0045831', '0048201', '0002907', '0048627', '0028664.']
2026-01-20 14:25:38,361 - shipping_chatbot - INFO - Analyst Engine processing query: select supplier_vendor_name from dataset where '6300146311' in po_number_multiple and hot_container_flag in ('Y', 'YES', 'TRUE', '1', 'HOT')
2026-01-20 14:25:43,163 - shipping_chatbot - INFO - ========================================
2026-01-20 14:25:43,163 - shipping_chatbot - INFO - ANALYST ENGINE DEBUG MODE
2026-01-20 14:25:43,163 - shipping_chatbot - INFO - QUERY: select supplier_vendor_name from dataset where '6300146311' in po_number_multiple and hot_container_flag in ('Y', 'YES', 'TRUE', '1', 'HOT')
2026-01-20 14:25:43,163 - shipping_chatbot - INFO - GENERATED CODE:
# Normalize hot_container_flag to string uppercase for consistent filtering
hot_flags = ['Y', 'YES', 'TRUE', '1', 'HOT']

# Filter rows where po_number_multiple contains '6300146311' and hot_container_flag is in hot_flags
filtered_df = df[
    df['po_number_multiple'].str.contains('6300146311', na=False) &
    df['hot_container_flag'].astype(str).str.upper().isin(hot_flags)
]

# Extract unique supplier_vendor_name values, dropna to avoid nulls
supplier_names = filtered_df['supplier_vendor_name'].dropna().unique()

# Format result as a comma-separated string or indicate no results
if len(supplier_names) > 0:
    result = ", ".join(supplier_names)
else:
    result = "No supplier_vendor_name found for PO#6300146311 with hot container flag."
2026-01-20 14:25:43,165 - shipping_chatbot - INFO - ========================================
2026-01-20 14:25:43,169 - shipping_chatbot - INFO - ANALYST ENGINE SUCCESS: Result obtained (length: 72)
2026-01-20 14:25:46,557 - shipping_chatbot - INFO - AGENT_STEP: 1 | Tool Used: Analyze Data with Pandas | Tool Input: select supplier_vendor_name from dataset where '6300146311' in po_number_multiple and hot_container_flag in ('Y', 'YES', 'TRUE', '1', 'HOT')
2026-01-20 14:33:17,456 - shipping_chatbot - INFO - AzureChatOpenAI ready
2026-01-20 14:33:17,456 - shipping_chatbot - INFO - Agent created with 4 tools
2026-01-20 14:33:17,456 - shipping_chatbot - INFO - Agent ready for HTTP requests
2026-01-20 14:33:30,404 - shipping_chatbot - INFO - AzureChatOpenAI ready
2026-01-20 14:33:30,404 - shipping_chatbot - INFO - Agent created with 4 tools
2026-01-20 14:33:30,407 - shipping_chatbot - INFO - Agent ready for HTTP requests
2026-01-20 14:34:12,433 - shipping_chatbot - INFO - AzureChatOpenAI ready
2026-01-20 14:34:12,433 - shipping_chatbot - INFO - Agent created with 4 tools
2026-01-20 14:34:12,433 - shipping_chatbot - INFO - Agent ready for HTTP requests
2026-01-20 14:52:07,958 - shipping_chatbot - INFO - AzureChatOpenAI ready
2026-01-20 14:52:07,959 - shipping_chatbot - INFO - Agent created with 4 tools
2026-01-20 14:52:07,959 - shipping_chatbot - INFO - Agent ready for HTTP requests
2026-01-20 14:54:11,484 - shipping_chatbot - INFO - User_Query: who is the supplier for FBIU0348756, consignee_code: ['0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569', '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052', '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360', '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453', '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359', '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392']
2026-01-20 14:54:11,484 - shipping_chatbot - INFO - Downloading shipment CSV from Azure Blob Storage
2026-01-20 14:54:25,519 - shipping_chatbot - INFO - Fetched 18991 rows
2026-01-20 14:54:25,525 - shipping_chatbot - INFO - Starting preprocessing on 18991 rows
2026-01-20 14:54:25,690 - shipping_chatbot - INFO - Removed 0 duplicate rows
2026-01-20 14:54:26,951 - shipping_chatbot - INFO - Converted 31 date columns to datetime format
2026-01-20 14:54:27,319 - shipping_chatbot - INFO - Normalized 6 'multiple' columns
2026-01-20 14:54:28,208 - shipping_chatbot - INFO - Added `delay_days` column with FIXED logic
2026-01-20 14:54:28,210 - shipping_chatbot - INFO - Added `actual_transit_days` column
2026-01-20 14:54:28,211 - shipping_chatbot - INFO - Added `estimated_transit_days` column
2026-01-20 14:54:28,283 - shipping_chatbot - INFO - Pre-processing finished - 18991 rows remain
2026-01-20 14:54:28,643 - shipping_chatbot - ERROR - Agent failed: "Input to ChatPromptTemplate is missing variables {'Y, YES, TRUE, 1, HOT'}.  Expected: ['Y, YES, TRUE, 1, HOT', 'agent_scratchpad', 'chat_history', 'consignee_code', 'input'] Received: ['input', 'chat_history', 'consignee_code', 'intermediate_steps', 'agent_scratchpad']"
Traceback (most recent call last):
  File "C:\Users\CHOWDHURYRaju\Desktop\roshan\StlnkWebNprdChatV2\api\main.py", line 201, in ask
    result = AGENT.invoke(
             ^^^^^^^^^^^^^
  File "C:\Users\CHOWDHURYRaju\AppData\Roaming\Python\Python311\site-packages\langchain\chains\base.py", line 166, in invoke
    raise e
  File "C:\Users\CHOWDHURYRaju\AppData\Roaming\Python\Python311\site-packages\langchain\chains\base.py", line 156, in invoke
    self._call(inputs, run_manager=run_manager)
  File "C:\Users\CHOWDHURYRaju\AppData\Roaming\Python\Python311\site-packages\langchain\agents\agent.py", line 1433, in _call
    next_step_output = self._take_next_step(
                       ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\CHOWDHURYRaju\AppData\Roaming\Python\Python311\site-packages\langchain\agents\agent.py", line 1139, in _take_next_step
    [
  File "C:\Users\CHOWDHURYRaju\AppData\Roaming\Python\Python311\site-packages\langchain\agents\agent.py", line 1139, in <listcomp>
    [
  File "C:\Users\CHOWDHURYRaju\AppData\Roaming\Python\Python311\site-packages\langchain\agents\agent.py", line 1167, in _iter_next_step
    output = self.agent.plan(
             ^^^^^^^^^^^^^^^^
  File "C:\Users\CHOWDHURYRaju\AppData\Roaming\Python\Python311\site-packages\langchain\agents\agent.py", line 398, in plan
    for chunk in self.runnable.stream(inputs, config={"callbacks": callbacks}):
  File "C:\Users\CHOWDHURYRaju\AppData\Roaming\Python\Python311\site-packages\langchain_core\runnables\base.py", line 2775, in stream
    yield from self.transform(iter([input]), config, **kwargs)
  File "C:\Users\CHOWDHURYRaju\AppData\Roaming\Python\Python311\site-packages\langchain_core\runnables\base.py", line 2762, in transform
    yield from self._transform_stream_with_config(
  File "C:\Users\CHOWDHURYRaju\AppData\Roaming\Python\Python311\site-packages\langchain_core\runnables\base.py", line 1778, in _transform_stream_with_config
    chunk: Output = context.run(next, iterator)  # type: ignore
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\CHOWDHURYRaju\AppData\Roaming\Python\Python311\site-packages\langchain_core\runnables\base.py", line 2726, in _transform
    for output in final_pipeline:
  File "C:\Users\CHOWDHURYRaju\AppData\Roaming\Python\Python311\site-packages\langchain_core\runnables\base.py", line 1154, in transform
    for ichunk in input:
  File "C:\Users\CHOWDHURYRaju\AppData\Roaming\Python\Python311\site-packages\langchain_core\runnables\base.py", line 4644, in transform
    yield from self.bound.transform(
  File "C:\Users\CHOWDHURYRaju\AppData\Roaming\Python\Python311\site-packages\langchain_core\runnables\base.py", line 1154, in transform
    for ichunk in input:
  File "C:\Users\CHOWDHURYRaju\AppData\Roaming\Python\Python311\site-packages\langchain_core\runnables\base.py", line 1172, in transform
    yield from self.stream(final, config, **kwargs)
  File "C:\Users\CHOWDHURYRaju\AppData\Roaming\Python\Python311\site-packages\langchain_core\runnables\base.py", line 814, in stream
    yield self.invoke(input, config, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\CHOWDHURYRaju\AppData\Roaming\Python\Python311\site-packages\langchain_core\prompts\base.py", line 128, in invoke
    return self._call_with_config(
           ^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\CHOWDHURYRaju\AppData\Roaming\Python\Python311\site-packages\langchain_core\runnables\base.py", line 1509, in _call_with_config
    context.run(
  File "C:\Users\CHOWDHURYRaju\AppData\Roaming\Python\Python311\site-packages\langchain_core\runnables\config.py", line 365, in call_func_with_variable_args
    return func(input, **kwargs)  # type: ignore[call-arg]
           ^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\CHOWDHURYRaju\AppData\Roaming\Python\Python311\site-packages\langchain_core\prompts\base.py", line 111, in _format_prompt_with_error_handling
    _inner_input = self._validate_input(inner_input)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\CHOWDHURYRaju\AppData\Roaming\Python\Python311\site-packages\langchain_core\prompts\base.py", line 103, in _validate_input
    raise KeyError(
KeyError: "Input to ChatPromptTemplate is missing variables {'Y, YES, TRUE, 1, HOT'}.  Expected: ['Y, YES, TRUE, 1, HOT', 'agent_scratchpad', 'chat_history', 'consignee_code', 'input'] Received: ['input', 'chat_history', 'consignee_code', 'intermediate_steps', 'agent_scratchpad']"
2026-01-20 14:54:28,864 - shipping_chatbot - INFO - Router: Set context (codes: ['0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569', '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052', '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360', '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453', '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359', '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392'], has_history: False) for query: who is the supplier for FBIU0348756
2026-01-20 14:54:29,029 - shipping_chatbot - INFO - Consignee filtering validated: 12583 rows for codes ['0000866', '0001363', '0001389', '0001540', '0001615', '0001660', '0001665', '0002565', '0002566', '0002569', '0002679', '0002907', '0002990', '0003235', '0003427', '0003717', '0003905', '0004932', '0004991', '0005052', '0005053', '0005056', '0005171', '0005172', '0005176', '0005177', '0005178', '0005179', '0005180', '0006360', '0006804', '0008579', '0008756', '0009633', '0012041', '0013505', '0015526', '0021103', '0021472', '0023453', '0025833', '0027113', '0028662', '0028664', '0029594', '0030961', '0030962', '0033522', '0033523', '0037359', '0037360', '0037361', '0037364', '0046854', '0047055', '0047302', '0047650', '0048392']
